import devtoolsJson from 'vite-plugin-devtools-json'
import { sveltekit } from '@sveltejs/kit/vite'
import { defineConfig, createLogger } from 'vite'
import { readFileSync } from 'fs'
import { composeVisitors } from 'lightningcss'
import { formatDate } from 'kitto'
import { breakpoints, fluid, size } from 'kitto/lightningcss'
import basicSsl from '@vitejs/plugin-basic-ssl'

const { name, version } = JSON.parse(readFileSync(new URL('package.json', import.meta.url), 'utf8'))
const logger = createLogger()
const loggerWarn = logger.warn

logger.warn = (msg, options) => {
	if (msg.includes('vite:css')) {
		if (msg.includes("'global'")) return
		if (msg.includes('@view-transition')) return
	}
	loggerWarn(msg, options)
}

export default defineConfig({
	build: { cssMinify: 'lightningcss' },
	css: {
		transformer: 'lightningcss',
		lightningcss: {
			drafts: { customMedia: true },
			visitor: composeVisitors([
				breakpoints({
					mobile: 640,
					tablet: 1024,
					laptop: 1280,
					desktop: 1440
				}),
				fluid({ vmax: 1600 }),
				size
			])
		}
	},
	define: {
		'import.meta.env.name': JSON.stringify(name),
		'import.meta.env.version': JSON.stringify(version),
		'import.meta.env.build': JSON.stringify(formatDate('{DD}-{MM}-{YYYY}@{HH}:{mm}:{ss}'))
	},
	plugins: [sveltekit(), devtoolsJson(), basicSsl()],
	resolve: { extensions: ['.mjs', '.js', '.ts', '.jsx', '.tsx', '.json', '.svelte'] },
	server: { proxy: {} },
	customLogger: logger
})
